"use strict";const Promise=require("bluebird"),request=require("superagent"),urlBuilder=require("./urlBuilder");function connection(t){this.host=t}connection.prototype.loginAsync=function(t){return this.token&&delete this.token,this.postAsync(urlBuilder.authentication,"login",{password:t}).then(t=>{if(!t.token)throw new Error("No login token found");return this.token=t.token,!0})},connection.prototype.logoutAsync=function(){return this.postAsync(urlBuilder.authentication,"logout").then(()=>(this.token&&delete this.token,!0))},connection.prototype.postAsync=function(t,e,n=null){try{let o={action:e,params:n||{}},r=request.post(this.host+urlBuilder.getPath(t));return this.token&&(r=r.auth(this.token,{type:"bearer"})),Promise.resolve(r.parse(this.cleanJSONParse).send(o).then(t=>{if(!t||!t.body||!t.body.result||t.body.errors&&Array.isArray(t.body.errors)&&t.body.errors.length>0)throw new Error(t.body.errors);return t.body}))}catch(t){return Promise.reject(t)}},connection.prototype.cleanJSONParse=function(t,e){t.text="",t.setEncoding("utf8"),t.on("data",function(e){t.text+=e}),t.on("end",function(){try{let n=t.text,o=n.indexOf("{");o>0&&(n=n.substring(o)),e(null,JSON.parse(n))}catch(t){e(t)}})},module.exports=connection;